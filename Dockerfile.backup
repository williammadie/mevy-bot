FROM python:3.13-slim

ENV PYTHONUNBUFFERED=1

# Install git (required for git-based dependencies)
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

# Add `uv` from prebuilt image
COPY --from=ghcr.io/astral-sh/uv:0.5.11 /uv /uvx /bin/

# Optional: enable bytecode compilation and copy link mode for uv
ENV UV_COMPILE_BYTE=1
ENV UV_LINK_MODE=copy

# Set working directory
WORKDIR /app
ENV PATH="/app/.venv/bin:$PATH"

# Copy dependency files to install from
COPY ./pyproject.toml ./uv.lock /app/

# Install dependencies only (no dev, no project install)
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-install-project --no-dev

# Copy the actual source code
COPY ./mevy_bot /app/mevy_bot

# Copy data definition
COPY ./data_definition/auto_sources.json /app/data_definition/auto_sources.json

# Copy utility scripts
COPY ./scripts /app/scripts

RUN echo "# Project README" > /app/README.md

# Sync again to install the project itself
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-dev

# Start the FastAPI production server
CMD ["fastapi", "run", "mevy_bot/routers/main.py", "--host", "0.0.0.0"]
